<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thinking of you</title>
    <script src="libraries/d3.v6.min.js"></script>
    <script src="libraries/darkmode-js.min.js"></script>
    <script src="scripts/helpers.js"></script>
    <script src="scripts/chart-messages-overview.js"></script>
    <script src="scripts/chart-thoughts-hourly.js"></script>
    <script src="scripts/chart-thoughts-timeline.js"></script>
    <script src="scripts/chart-thoughts-today.js"></script>
    <script src="scripts/data-messages.js"></script>
    <script src="scripts/data-thoughts.js"></script>
    <script src="scripts/data-visits.js"></script>
    <style>
        body {
            font-family: Consolas;
        }

        .content {
            max-width: 1000px;
            margin: auto;
        }

        .day {
            stroke: #ccc;
        }

        .month {
            fill: none;
            stroke: #000;
            stroke-width: 2px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

        .line {
            fill: none;
            stroke: steelblue !important;
            stroke-width: 2px;
        }
        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .article {
            max-width: 1000px;
            /* display: none; */
        }
    </style>
</head>
<body>
    <div id="chart"></div>

    <div class="content">
        <div class="article">
            <h2>I was thinking about you just <span id="timeAgo">(wait for it)</span> ago
                <!-- <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                    <image href="resources/heart.svg" height="20" width="20" />
                </svg> -->
            </h2>
        </div>

        <div class="article">
            <h2>Thoughts today</h2>
        </div>
        <div id="thoughts-today"></div>

        <div class="article">
            <h2>Recent thought timeline</h2>
            <p>The following display "thought" counts over time</p>
        </div>
        <div id="thoughts-timeline"></div>

        <div class="article">
            <h2>Thoughts during the day</h2>
            <p>Shows when am I usually thinking about you.</p>
            <p>The data suggests it's most often when I wake up and when I go to sleep.</p>
        </div>
        <div id="thoughts-hourly"></div>

        <div class="article">
            <h2>Message history</h2>
            <p>The following charts display combined word counts we have shared over SMS, Facebook and WhatsApp. It means to illustrate how our contact evolved over the years.</p>
        </div>
        <div id="messages-overview"></div>
    </div>
    
    <script>
        const options = {
            bottom: '32px', // default: '32px'
            right: '32px', // default: '32px'
            left: 'unset', // default: 'unset'
            time: '0.5s', // default: '0.3s'
            mixColor: '#fff', // default: '#fff'
            backgroundColor: '#fff',  // default: '#fff'
            buttonColorDark: '#100f2c',  // default: '#100f2c'
            buttonColorLight: '#fff', // default: '#fff'
            saveInCookies: false, // default: true,
            label: 'ðŸŒ“', // default: ''
            autoMatchOsTheme: true // default: true
        }

        // const darkmode = new Darkmode(options);

        // darkmode.showWidget();    
    </script>



    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'
        import { getFirestore, connectFirestoreEmulator, collection, doc, getDoc, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'
 
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCdsLdaLzaSDZnyR-evvlbfYmGt0mHpgmA",
          authDomain: "k-thoughts-db.firebaseapp.com",
          projectId: "k-thoughts-db",
          storageBucket: "k-thoughts-db.appspot.com",
          messagingSenderId: "753934912285",
          appId: "1:753934912285:web:63e6e3ded1ad23f92baff4"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // const db = getFirestore();
        // connectFirestoreEmulator(db, '127.0.0.1', 8080);


        var thoughts = await fetchThoughts();
        var messages = await fetchMessages();

        // const summaryThoughtsHourly = await getSummaryThoughtsHourly();
        // const summaryThoughtsDaily = await getSummaryThoughtsDaily();
        // const summaryThoughtsToday = await getSummaryThoughtsToday();
        // const wordCountsPerDay = await getWordCountsPerDay();

        async function fetchThoughts() {
            const docRef = doc(db, "raw", "thoughts")
            const snapshot = await getDoc(docRef);
            const data = snapshot.data().thoughtOn;
            return data;
        }
        async function populateThoughts(){
            thoughts = await fetchThoughts();
            console.log("Thoughts populated");
        }

        async function fetchMessages() {
            const docRef = doc(db, "raw", "messages")
            const snapshot = await getDoc(docRef);
            const data = snapshot.data().summary;
            return data;
        }
        async function populateMessagess(){
            thoughts = await fetchMessages();
            console.log("Messages populated");
        }

        // async function getSummaryThoughtsHourly() {
        //     const colRef = collection(db, 'summaryThoughtsHourly');
        //     const snapshot = await getDocs(colRef);
        //     const data = snapshot.docs.map(doc => doc.data());
        //     return data;
        // }
        // async function getSummaryThoughtsDaily() {
        //     const colRef = collection(db, 'summaryThoughtsDaily');
        //     const snapshot = await getDocs(colRef);
        //     const data = snapshot.docs.map(doc => ({
        //         thoughtOn: new Date(doc.id),
        //         thoughtCount: doc.data().thoughtCount
        //     }));
        //     return data;
        // }
        // async function getSummaryThoughtsToday() {
        //     const colRef = collection(db, 'groupThoughtsDaily');
        //     const snapshot = await getDocs(colRef);
        //     const data = snapshot.docs.map(doc => ({
        //         thoughtOnDate: new Date(doc.id),
        //         thoughtOnDateTime: doc.data().thoughtOn
        //     }));
        //     return data;
        // }
        // async function getWordCountsPerDay() {
        //     const docRef = doc(db, "summaryMessages", "wordCountsPerDay")
        //     const snapshot = await getDoc(docRef);
        //     const data = snapshot.data().summary;
        //     return data;
        // }

        createChart_ThoughtsToday("thoughts-today", thoughts); // (summaryThoughtsToday[summaryThoughtsToday.length-1]).thoughtOnDateTime);
        createChart_ThoughtsTimeline("thoughts-timeline", thoughts); // summaryThoughtsDaily //getThoughtsDataNew //getThoughtsData() //thoughts
        createChart_ThoughtsHourly("thoughts-hourly", thoughts); // summaryThoughtsHourly // getThoughtsDataNew() //getThoughtsData() //thoughts
        createChart_MessagesOverview("messages-overview", messages); //getMessagesDailyData2() //messagesDailySummary
        
        async function updateTimeSince() {
            const latestThoughtOn = new Date(d3.max(thoughts));
            const timeAgoText = timeAgo(latestThoughtOn);
            document.getElementById("timeAgo").innerText = timeAgoText;
        }

        // Update stored latest thought every 15 seconds
        setInterval(populateThoughts, 15000);
        // Update the span every second
        setInterval(updateTimeSince, 1000);

        // Initial call to display the time immediately when the page loads
        updateTimeSince();

        // Add visit record
        addVisit();
 
        // async function updateLatestThought(){
        //     latestThought = await getLatestThought();
        // }
        // async function getLatestThought(){
        //     const collectionRef = collection(db, "thoughts");
        //     const q = query(collectionRef, orderBy("thoughtOn", "desc"), limit(1));

        //     const querySnapshot = await getDocs(q);
        //     querySnapshot.forEach((doc) => {
        //         console.log(doc.data());
        //     });

        //     const thoughtData = querySnapshot.docs[0].data();

        //     return thoughtData;
        // }
    </script>

</body>
</html>

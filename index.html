<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar Chart with D3.js</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="scripts/helpers.js"></script>
    <script src="scripts/chart-messages-overview.js"></script>
    <script src="scripts/chart-thoughts-hourly.js"></script>
    <script src="scripts/chart-timeline.js"></script>
    <script src="scripts/data-messages.js"></script>
    <script src="scripts/data-thoughts.js"></script>
    <script src="scripts/data-visits.js"></script>
    <style>
        body {
            font-family: Consolas;
        }

        .day {
            stroke: #ccc;
        }

        .month {
            fill: none;
            stroke: #000;
            stroke-width: 2px;
        }

        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }

        .line {
            fill: none;
            stroke: steelblue;
            stroke-width: 2px;
        }
        .grid line {
            stroke: lightgrey;
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }

        .article {
            max-width: 1000px;
        }
    </style>
</head>
<body>
    <div class="article">
        <h2>I was thinking about you just <span id="timeAgo"></span> ago
            <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg">
                <image href="resources/heart.svg" height="20" width="20" />
            </svg>
        </h2>
        <p>Whenever I was thinking of you, wondering how was your day, what you were doing, what animals are you saving ... but did not want to spam you even more than I already do, I send a "thought" to the database. For this I wrote a small application for my watch, to make it very convenient.</p>
        <p>The approach is based on me manually triggering the "thought" upload, which has the following issues:</p>
        <ul>
            <li>it doesn't distinguish the "thought" quality or length</li>
            <li>when I am with you, you are the only thing I think about, I don't have time to upload "thought"</li>
            <li>while building this project, I am obviously thinking of you, yet too consumed by getting it done</li>
        </ul>
    </div>

    <div class="article">
        <h2>Recent thought timeline</h2>
        <p>The following display "thought" counts over time</p>
        <p>On 31.5 the idea popped in my head. On 3.6 I had a functional prototype ready and started gathering data. </p>
    </div>
    <div id="recent-timeline-chart"></div>

    <div class="article">
        <h2>Thoughts during the day</h2>
        <p>Shows when am I usually thinking about you.</p>
        <p>The data suggests it's most often when I wake up and when I go to sleep.</p>
    </div>
    <div id="thoughts-hourly"></div>

    <div class="article">
        <h2>Message history</h2>
        <p>The following charts display combined word counts we have shared over SMS, Facebook and WhatsApp. It means to illustrate how our contact evolved over the years.</p>
        <p>The approach focusing on text messages has the following issues:</p>
        <ul>
            <li>it doesn't take into account calls or in-person conversations</li>
        </ul>
    </div>
    <div id="messages-overview"></div>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js'
        import { getAuth } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js'
        import { getFirestore, collection, getDocs, query, orderBy, limit } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js'
 
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyCdsLdaLzaSDZnyR-evvlbfYmGt0mHpgmA",
          authDomain: "k-thoughts-db.firebaseapp.com",
          projectId: "k-thoughts-db",
          storageBucket: "k-thoughts-db.appspot.com",
          messagingSenderId: "753934912285",
          appId: "1:753934912285:web:63e6e3ded1ad23f92baff4"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let latestThought = await getLatestThought();

        const thoughts = await getThoughts(db);
        const thoughtsDailySummary = await getThoughtsDailySummary(db);
        const messagesDailySummary = await getMessagesDailySummary(db);

        async function getThoughts(db) {
            const thoughtsCol = collection(db, 'thoughts');
            const thoughtSnapshot = await getDocs(thoughtsCol);
            const thoughtList = thoughtSnapshot.docs.map(doc => doc.data());
            return thoughtList;
        }

        async function getThoughtsDailySummary(db) {
            const thoughtsCol = collection(db, 'thoughtsDailySummary');
            const thoughtSnapshot = await getDocs(thoughtsCol);
            const thoughtList = thoughtSnapshot.docs.map(doc => doc.data());
            return thoughtList;
        }

        async function getMessagesDailySummary(db) {
            const messagesCol = collection(db, 'messagesDailySummary');
            const messageSnapshot = await getDocs(messagesCol);
            const messageList = messageSnapshot.docs.map(doc => doc.data());
            return messageList;
        }

        createChart_MessagesOverview("messages-overview", messagesDailySummary); //getMessagesDailyData2()
        createChart_ThoughtsHourly("thoughts-hourly", thoughts); //getThoughtsData()
        createChart_Timeline("recent-timeline-chart", thoughts); //getThoughtsData()

        async function updateTimeSince() {
            const latestThoughtOn = new Date(latestThought.thoughtOn);
            const timeAgoText = timeAgo(latestThoughtOn);
            document.getElementById("timeAgo").innerText = timeAgoText;
        }

        // Update stored latest thought every 30 seconds
        setInterval(updateLatestThought, 30000);
        // Update the span every second
        setInterval(updateTimeSince, 1000);

        // Initial call to display the time immediately when the page loads
        updateTimeSince();

        // Add visit record
        addVisit();
 
        async function updateLatestThought(){
            latestThought = await getLatestThought();
        }
        async function getLatestThought(){
            const collectionRef = collection(db, "thoughts");
            const q = query(collectionRef, orderBy("thoughtOn", "desc"), limit(1));

            const querySnapshot = await getDocs(q);
            querySnapshot.forEach((doc) => {
                console.log(doc.data());
            });

            const thoughtData = querySnapshot.docs[0].data();

            return thoughtData;
        }
    </script>

</body>
</html>
